---
// Import global styles
import "@/styles/global.css";
import "@/styles/animations.css";
import SiteData from "@/config/siteData.json";
import { THEME_KEY } from "@/config/variables";
// If you already have config files, import them here:
import { locales, defaultLocale, type Locale } from "@/i18n/config";
import { getPageTranslations } from "@/i18n/i18n";
import { Toaster } from "@/components/ui/sonner";
import { SEO, type SEOProps } from "astro-seo";

// Layout components
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";

// Props:
// - locale: current locale (can be string from URL params, will be validated)
// - pageNS: array of namespace names to load, e.g., ["home", "nav"]
// - title/description: SEO
// - alternates: map of locale -> URL for hreflang
const {
  locale: localeParam,
  pageNS = [], // e.g., ["home", "nav"]
  alternates = {} as Record<string, string>,
  seo,
} = Astro.props as {
  locale?: string | Locale;
  pageNS?: string[];
  alternates?: Record<string, string>;
  seo?: SEOProps;
};

// Validate locale - we assume valid locale since routing handles invalid ones
const activeLocale = (localeParam as Locale) || defaultLocale;

// Use the utility function to get translations (including navigation and common)
const { t, dir } = await getPageTranslations(activeLocale, [
  ...pageNS,
  "common",
  "nav",
]);

// Build absolute URL for canonical
const site = Astro.site?.origin ?? "https://example.com";
const url = new URL(Astro.url, site).href;
---

<html lang={activeLocale} dir={dir}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Canonical + hreflang -->
    <link rel="canonical" href={url} />
    {
      Object.entries(alternates).map(([lc, href]) => (
        <link rel="alternate" hreflang={lc} href={href} />
      ))
    }

    <!-- No-flash theme restore -->
    <script is:inline define:vars={{ THEME_KEY }}>
      try {
        const theme = localStorage.getItem(THEME_KEY);
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
        // eslint-disable-next-line @typescript-eslint/no-unused-vars
      } catch (e) {}
    </script>

    <link rel="alternate" hreflang="x-default" href={`${site}/`} />

    <!-- Sitemap and robots -->
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Add SEO component from astro-seo -->
    <SEO
      title={seo?.title || SiteData.default.title}
      description={seo?.description ?? SiteData.default.description}
      openGraph={seo?.openGraph ?? {
        basic: {
          image: SiteData.default.openGraph.image,
          title: SiteData.default.openGraph.title,
          type: SiteData.default.openGraph.type,
          url: SiteData.default.openGraph.url,
        },
        optional: {
          description: SiteData.default.openGraph.description,
          siteName: SiteData.default.openGraph.title,
        },
      }}
      twitter={seo?.twitter ?? {
        title: SiteData.default.twitter.title,
        description: SiteData.default.twitter.description,
        creator: SiteData.default.twitter.creator,
      }}
    />
  </head>

  <body>
    <!-- Navigation Header -->
    <Header
      logoText={t("site.name", "Туры по Лигурии")}
      logoHref={`/`}
      navItems={[
        {
          label: t("nav.tours", "Туры с гидом"),
          href: `/#tours`,
        },
        {
          label: t("nav.about", "Обо мне"),
          href: `/about-me`,
        },
        {
          label: t("nav.contact", "Контакты"),
          href: `/#contact`,
        },
      ]}
      fixed={true}
      showThemeToggle={true}
      showLanguageSwitcher={true}
      showMobileMenu={true}
      currentLocale={activeLocale}
      transparent={true}
    />

    <main>
      <slot />
    </main>

    <!-- Footer -->
    <Footer
      locale={activeLocale}
      logoText={t("site.name", "Туры по Лигурии")}
      logoHref={`/`}
      copyrightText={t(
        "footer.copyright",
        "© 2025 Туры по Лигурии. Все права защищены."
      )}
      showNewsletter={true}
      newsletterTitle={t("footer.newsletter.title", "Stay Updated")}
      newsletterDescription={t(
        "footer.newsletter.description",
        "Get the latest updates and insights delivered to your inbox."
      )}
    />

    <Toaster client:load />

    <!-- Simple Scroll Animations (fallback for older browsers) -->
    <script src="/src/utils/scroll-animations.ts"></script>
  </body>
</html>
