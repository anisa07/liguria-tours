---
import Container from "@/components/layout/Container.astro";
import { getPageTranslations } from "@/i18n/i18n";
import type { Locale } from "@/i18n/config";
import { getCollection } from "astro:content";

export interface Props {
  locale: Locale;
}

const { locale } = Astro.props;

// Get the translation function
const { t } = await getPageTranslations(locale, ["common", "ui", "home"]);

// Load boat tours from content collection for images
const boatToursCollection = await getCollection("boatTourCollection");
const boatToursData = boatToursCollection && boatToursCollection[0]?.data;
const allBoatTours = boatToursData?.tours || [];

// Stories for each location with enhanced information
const locationStories: Record<string, string> = {
  portofino:
    "ПОРТОФИНО — обязательное место посещения именитых лиц и одна из самых фотографируемых гаваней в мире.\n\nЛигурия обязана ему всемирной славой. На его маленькой территории уместился необъятный мир полный контрастов. Миниатюрная гавань с разноцветной стеной домов обладает небывалым количеством достоинств.\n\nЗдесь швартовались яхты Аристотеля Онассиса и принца Ренье, а вилла Портофино служила декорацией для фильмов с участием Элизабет Тейлор и Хамфри Богарта.\n\nРядом — церковь Святого Георгия с реликвиями, привезенными крестоносцами из Святой земли, средневековый замок Кастелло Браун с божественным панорамным видом на залив, виллы знаменитостей и рай для шопинга со всемирно известными брендами.\n\nНебольшое местечко с громким именем обещает оставить вам несравненное впечатление. И это совсем не значит, что любой желающий не сможет сюда попасть, хотя бы для того, чтобы соблазниться цветами и вкусами «Dolce Vita», которые оставляют на этой земле отпечатки уникальности и шарма.",
  "san-fruttuoso":
    "САН-ФРУТОЗО — оазис спокойствия, нетронутый урбанизацией, доступный только по морю или пешком.\n\nБенедиктинское аббатство X века, основанное епископом Просперо Генуэзским, стоит в полном уединении в маленькой бухте под защитой горы Портофино. Аббатство-монастырь без монахов хранит гробницы семьи Дориа — знаменитых генуэзских адмиралов.\n\nУникальный микроклимат, сине-зеленая гладь воды, горы и чистейший пляж являются любимым местом для купания в жаркие дни.\n\nНо главная достопримечательность скрыта под водой: на 17-метровой глубине в морских пучинах бухты установлена бронзовая статуя «Христос из Бездны» (Cristo degli Abissi) высотой 2,5 метра. Созданная скульптором Гуидо Галлетти в 1954 году, она была установлена в память о погибшем дайвере Дарио Гонзатти.\n\nХристос с воздетыми к небу руками благословляет рыбаков на улов, моряков на попутный ветер и всех ныряльщиков, исследующих подводный мир Лигурии.",
  "santa-margherita":
    "САНТА-МАРГАРИТА ЛИГУРЕ — элегантный курорт, соединивший в себе культуру, архитектуру Belle Époque и средиземноморское очарование.\n\nГород расцвел в XIX веке, когда европейская аристократия открыла для себя красоту Лигурийской Ривьеры. Роскошные отели времен «Прекрасной эпохи», буйное цветение магнолий и пальм, всегда тихое море и солнечные ванны привлекали сюда английскую знать.\n\nБазилика Святой Маргариты Антиохийской XVII века поражает роскошью барочных интерьеров. Вилла Дураццо с ботаническим садом и замок на холме создают романтическую атмосферу.\n\nНе забудьте отобедать в уютных тратториях на набережной. И пусть вас не пугает их простой вид — здесь едят местные, а это значит, что именно тут самая вкусная еда. Для изысканных гурманов рядом — рестораны с мишленовскими звездами и летними верандами с видом на залив.\n\nПопробуйте местную фокаччу с сыром, свежие анчоусы и вина из виноградников Портофино. Насладитесь удовольствием и не удивляйтесь, если вам не захочется отсюда уезжать.",
  rapallo:
    "РАПАЛЛО — очаровательный курорт и жемчужина Тигуллийского залива, где расположены лучшие отели, гольф-клубы и где всегда рады туристам.\n\nГород прославился в 1920-е годы, когда здесь отдыхали Эрнест Хемингуэй, Фридрих Ницше и Эзра Паунд. Именно в Рапалло был подписан важный международный договор 1922 года между Советской Россией и Германией.\n\nНабережная Витторио Венето тянется вдоль моря на два километра, обрамленная пальмами и элегантными палаццо. В центре — средневековый замок XVI века, стоящий прямо в воде, построенный для защиты от пиратских набегов.\n\nЗдесь всегда есть чем заняться: прогуляться по променаду, окунуться в историю или в изумрудное море, отведать местную кухню, которая славится блюдами из свежей рыбы и морепродуктов — особенно знамениты лангустины и паста с морскими ежами.\n\nПодняться на фуникулере на гору Монталлегро (612 метров) к святилищу Богоматери XVI века и насладиться головокружительной панорамой залива Тигуллио, которую называют «Залив Дельфинов».",
  "sestri-levante":
    "СЕСТРИ ЛЕВАНТЕ — сказочный городок, сочетающий в себе шарм маленьких итальянских городов с узкими улочками, каменными мостовыми, старыми церквями и античным замком.\n\nГород расположен на полуострове и уникален тем, что имеет сразу две бухты. С одной стороны — Бухта Тишины (Baia del Silenzio), маленькая и защищенная от ветров, с золотистым песком. С другой — Бухта Сказок (Baia delle Favole), более оживленная, с длинной набережной.\n\nБухта Сказок получила свое поэтическое название в честь датского сказочника Ганса Христиана Андерсена, который провел здесь зиму 1833 года и был настолько очарован местными пейзажами, что посвятил этому месту целую главу в своих мемуарах.\n\nИсторический центр полон средневекового очарования: палаццо Дуранте-Нeгротто, церковь Святого Николая XII века, и руины замка на мысе.\n\nГород славится своими пляжами, получившими «Голубой флаг» за чистоту воды, и является популярным курортом у итальянцев, сохранившим аутентичную атмосферу.",
  monterosso:
    "МОНТЕРОССО АЛЬ МАРЕ — самый большой и единственный городок Чинкве Терре с настоящими пляжами и древнейшей историей.\n\nОснованный в XI веке, Монтероссо в отличие от других городков имеет широкий выход к морю и два прекрасных пляжа: песчаный Феджина и галечный в старой части.\n\nГород состоит из двух частей, разделенных высокой скалой — холмом Святого Христофора. В скале прорублен туннель, соединяющий новую и старую части.\n\nВыйдя с кораблика, путник оказывается на длинной набережной с лавочками, фонарями, цветниками, пиниями и пальмами. Набережная упирается в скалу с руинами средневековой крепости Аврора XIII века.\n\nНа холме Святого Христофора стоит францисканский монастырь-капуцинов с церковью Сан-Франческо XVII века. Здесь хранится «Распятие» работы Ван Дейка и фрески XIV века.\n\nНе пропустите Гиганта — 14-метровую статую Нептуна, созданную в 1910 году, и попробуйте местные анчоусы Monterosso, защищенные знаком качества IGP, и белое вино Cinque Terre DOC.\n\nЗдесь разлита особая задушевная атмосфера старой Лигурии.",
  vernazza:
    "ВЕРНАЦЦА — самая живописная и фотогеничная деревня Чинкве Терре, считающаяся одной из красивейших в Италии.\n\nОснованная в XI веке семьей Obertenghi, Вернацца была важным морским форпостом Генуэзской республики. Ее название происходит от латинского «Vulnetia» — священное место.\n\nОсобенно красиво у моря: перед бухтой широкая площадь Пьяцца Марчони с летними кафе, часть бухты защищена молом из огромных валунов, по которым карабкаются туристы, глядя в морскую даль.\n\nНа скале высится замок Дориа XI века — Кастелло Дория, древнейшее укрепление Чинкве Терре с круглой башней высотой 70 метров. Прямо под ним примостился ресторанчик на несколько столиков с незабываемым видом.\n\nС другой стороны — церковь Санта-Маргерита д'Антиокия XIV века с восьмиугольной колокольней — символ Вернаццы, единственная церковь в Чинкве Терре, выходящая фасадом к морю.\n\nЗа церковью начинается оживленный лабиринт узких улочек — каруджи, ведущих вверх к виноградным террасам. В 2011 году городок пострадал от наводнения, но был восстановлен и стал еще прекраснее.",
  corniglia:
    "КОРНИЛЬЯ — самая высокая и уединенная деревня Чинкве Терре, единственная без выхода к морю.\n\nВдали показывается склон с густо налепленными яркими домишками, напоминающими игрушечные домики. Ощущение, будто перед вами проплывает сказочная страна из книг Толкина, где живут хоббиты.\n\nОснованная римлянами в I веке н.э., Корнилья получила название от римского рода Cornelia, владевшего этими землями. Древний историк Плиний Старший упоминает местное вино «Cornelium» как одно из лучших в империи.\n\nСюда корабли не заходят — деревня разместилась на склоне холма на высоте 100 метров над уровнем моря. Чтобы попасть в центр, нужно преодолеть знаменитую лестницу Лардарина (Lardarina) из 377 ступеней, построенную в XIII веке.\n\nИз всех городков Чинкве-Терре он наименее посещаем туристами, что сохранило его аутентичность. Основал его некий Корнелий из рода Корнельев, который местные склоны засадил виноградниками.\n\nНебольшая площадь с террасой Санта-Мария — идеальное место для наблюдения за закатом. Попробуйте джелато с местным вином Sciacchetrà в баре Альберто.",
  manarola:
    "МАНАРОЛА — древнейший городок Чинкве Терре, основанный еще в XII веке, и один из самых романтичных.\n\nКрохотный городок разворачивается во всех своих ракурсах. Разноцветные домики-башни буквально спускаются каскадом до самого моря, создавая невероятный вертикальный пейзаж.\n\nНазвание происходит от латинского «Manium arula» — алтарь богов Манов, древних римских божеств.\n\nОтсюда отлично видна знаменитая Тропа Любви (Via dell'Amore) — романтическая дорожка длиной 900 метров, прорубленная в скалах между Манаролой и Риомаджоре в 1920-х годах. Говорят, что пары, поцеловавшиеся здесь на закате, будут вместе вечно.\n\nЦерковь Сан-Лоренцо 1338 года с готическим фасадом из местного белого камня — прекрасный образец готики Генуэзской школы.\n\nМанарола славится своим вином — здесь производят легендарное сладкое вино Sciacchetrà из заизюмленного винограда, выращенного на головокружительных террасах.\n\nПричала как такового нет — туристы высаживаются прямо на скалы. На Рождество весь склон превращается в самый большой в мире светящийся вертеп (Presepe) с 300 фигурами.",
  riomaggiore:
    "РИОМАДЖОРЕ — самый южный и восточный городок Чинкве Терре, ворота в Национальный парк.\n\nОснованный в VIII веке греческими беженцами, спасавшимися от византийского иконоборчества, городок получил название от «Rivus major» — большой ручей. Яркий, многоступенчатый, самый вертикальный из Пяти земель.\n\nРиомаджоре словно отступил вглубь суши от наступающего моря и полез вверх на окрестные холмы. Типичные лигурийские дома-башни XIII-XIV веков окрашены в яркие цвета — красный, желтый, розовый — чтобы рыбаки могли издалека увидеть свой дом.\n\nГлавная улица Via Colombo (названная в честь Христофора Колумба) проходит над бурным ручьем, спрятанным под мостовой. По обе стороны лепятся дома, магазинчики и траттории.\n\nЦерковь Сан-Джованни Баттиста 1340 года с мраморным порталом и готической розой — жемчужина генуэзской готики.\n\nМарина ди Риомаджоре — крошечная гавань, окруженная скалами, где местные рыбаки до сих пор хранят свои лодки в выдолбленных в скале гротах.\n\nНа холме Монтенеро открывается захватывающий вид на всё побережье Чинкве Терре, крепость Дориа и далекий Портовенере с церковью Сан-Пьетро на мысу.",
  portovenere:
    "ПОРТОВЕНЕРЕ — жемчужина Лигурии и объект Всемирного наследия ЮНЕСКО, город с трехтысячелетней историей.\n\nОснованный римлянами в I веке до н.э. как «Portus Veneris» — порт Венеры, богини любви, город и сегодня сохраняет свою магическую атмосферу.\n\nМы проходим по узкому проливу между островом Пальмария и выстроенным в линейку разноцветным рядом высоких средневековых домов-башен XIII века. Типично генуэзский городок: яркие фасады вдоль кромки воды, дома, карабкающиеся по крутому склону.\n\nНа вершине — крепость Кастелло Дориа XII-XVII веков, построенная генуэзцами для защиты от пизанцев и сарацинских пиратов.\n\nНо символ Портовенере — церковь Сан-Пьетро (Святого Петра), стоящая на самом краю скального мыса. Построенная в VI веке на руинах римского храма Венеры, она перестроена в XIII веке в полосатом генуэзском стиле.\n\nЕсли нужно было выбрать символ «дороги к храму» — это была бы эта картина. Портовенере — не просто пейзаж, это символ духовного пути.\n\nНа утесе храм стоит совершенно один, в своей простоте сливаясь с камнем. Путник проходит пустое пространство, притянутый к храму, отсекая всё постороннее. Когда выходишь на галерею — возникает головокружительный вид на слоистые скалы, море и остров Пальмария.\n\nЗдесь любил бывать Джордж Гордон Байрон, который переплывал залив от Сан-Терензо до грота Арпайи (Grotta Arpaia), названного позже его именем.",
};

// Flatten all tour points into one array with stories
const allImages = allBoatTours.flatMap((tour: any) =>
  tour.tourPoints.map((point: any) => ({
    image: point.image,
    alt: point.alt,
    title: point.title,
    description: point.description,
    story: locationStories[point.id] || point.description,
  }))
);
---

<!-- Liguria History Gallery Section -->
<section
  id="history"
  class="py-24 bg-gradient-to-b from-background via-primary/5 to-background"
>
  <Container size="xl" padding="lg">
    <div class="text-center mb-20">
      <h2 class="text-5xl md:text-6xl font-bold mb-6 tracking-tight">
        <span class="text-primary">Истории</span>
        <span class="text-foreground"> Лигурии</span>
      </h2>

      <div
        class="w-32 h-1 bg-gradient-to-r from-transparent via-primary to-transparent mx-auto mb-6"
      >
      </div>

      <p class="text-xl text-foreground/70 max-w-3xl mx-auto">
        Живописные места и легендарные города итальянской Ривьеры
      </p>
    </div>

    <!-- Image Gallery Grid -->
    <div
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
    >
      {
        allImages.map((item: any, index: number) => (
          <div
            class="history-card group relative overflow-hidden rounded-3xl shadow-lg hover:shadow-2xl transition-all duration-500 cursor-pointer"
            data-index={index}
            data-story={item.story}
          >
            <div class="aspect-[3/4] overflow-hidden">
              <img
                src={item.image.src}
                alt={item.alt}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                loading="lazy"
              />
            </div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent opacity-100 group-hover:opacity-90 transition-opacity duration-300">
              <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                <h3 class="text-xl font-bold mb-3 line-clamp-1 transform translate-y-0 group-hover:translate-y-[-4px] transition-transform duration-300">
                  {item.title}
                </h3>
                <p class="text-sm leading-relaxed opacity-90 line-clamp-3 transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                  {item.description}
                </p>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <!-- Lightbox Modal -->
    <div
      id="lightbox"
      class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center p-4"
    >
      <button
        id="close-lightbox"
        class="absolute top-4 right-4 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-all z-10"
        aria-label="Close"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <button
        id="prev-slide"
        class="absolute left-2 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-all z-10"
        aria-label="Previous"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>

      <div
        class="max-w-7xl w-full h-full flex items-center justify-center py-20"
      >
        <div
          class="relative w-full h-full flex flex-col lg:flex-row gap-8 items-center overflow-hidden"
        >
          <!-- Image Section -->
          <div class="w-full lg:w-1/2 flex items-center justify-center">
            <img
              id="lightbox-image"
              src=""
              alt=""
              class="max-w-full max-h-[70vh] object-contain rounded-2xl shadow-2xl"
            />
          </div>

          <!-- Story Section -->
          <div
            class="w-full lg:w-1/2 max-h-[70vh] overflow-y-auto custom-scrollbar px-8"
          >
            <div class="text-white">
              <h3
                id="lightbox-title"
                class="text-3xl md:text-4xl font-bold mb-6 text-primary leading-tight"
              >
              </h3>
              <div
                id="lightbox-story"
                class="text-base md:text-lg text-white/95"
              >
              </div>
            </div>
          </div>
        </div>
      </div>

      <button
        id="next-slide"
        class="absolute right-2 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-all"
        aria-label="Next"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
    </div>
  </Container>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const historyCards = document.querySelectorAll(".history-card");
    const lightbox = document.getElementById("lightbox");
    const lightboxImage = document.getElementById(
      "lightbox-image"
    ) as HTMLImageElement;
    const lightboxTitle = document.getElementById("lightbox-title");
    const lightboxStory = document.getElementById("lightbox-story");
    const closeBtn = document.getElementById("close-lightbox");
    const prevBtn = document.getElementById("prev-slide");
    const nextBtn = document.getElementById("next-slide");

    if (
      !lightbox ||
      !lightboxImage ||
      !lightboxTitle ||
      !lightboxStory ||
      !closeBtn ||
      !prevBtn ||
      !nextBtn
    )
      return;

    let currentIndex = 0;
    const images: Array<{
      src: string;
      alt: string;
      title: string;
      story: string;
    }> = [];

    // Collect all images data including full stories
    historyCards.forEach((card) => {
      const img = card.querySelector("img");
      const title = card.querySelector("h3");
      const story = card.getAttribute("data-story");

      if (img && title && story) {
        images.push({
          src: img.src,
          alt: img.alt,
          title: title.textContent || "",
          story: story,
        });
      }
    });

    function showImage(index: number) {
      if (index < 0) index = images.length - 1;
      if (index >= images.length) index = 0;

      currentIndex = index;
      const image = images[currentIndex];

      lightboxImage.src = image.src;
      lightboxImage.alt = image.alt;
      if (lightboxTitle) lightboxTitle.textContent = image.title;
      if (lightboxStory) {
        // Split story into paragraphs by double newlines
        const paragraphs = image.story.split("\n\n").filter((p) => p.trim());
        lightboxStory.innerHTML = paragraphs
          .map(
            (p) =>
              `<p class="mb-5 text-justify leading-relaxed">${p.trim()}</p>`
          )
          .join("");

        // Scroll story to top when changing image
        const storyContainer = lightboxStory.parentElement;
        if (storyContainer) {
          storyContainer.scrollTop = 0;
        }
      }
    }

    function openLightbox(index: number) {
      showImage(index);
      if (lightbox) {
        lightbox.classList.remove("hidden");
        lightbox.classList.add("flex");
        document.body.style.overflow = "hidden";
      }
    }

    function closeLightbox() {
      if (lightbox) {
        lightbox.classList.add("hidden");
        lightbox.classList.remove("flex");
        document.body.style.overflow = "";
      }
    }

    // Add click handlers to cards
    historyCards.forEach((card, index) => {
      card.addEventListener("click", () => openLightbox(index));
    });

    // Navigation
    closeBtn.addEventListener("click", closeLightbox);
    prevBtn.addEventListener("click", () => showImage(currentIndex - 1));
    nextBtn.addEventListener("click", () => showImage(currentIndex + 1));

    // Click outside to close
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    // Keyboard navigation
    document.addEventListener("keydown", (e) => {
      if (!lightbox.classList.contains("hidden")) {
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") showImage(currentIndex - 1);
        if (e.key === "ArrowRight") showImage(currentIndex + 1);
      }
    });
  });
</script>

<style>
  .history-card {
    position: relative;
    animation: fadeInUp 0.6s ease-out backwards;
  }

  .history-card:nth-child(1) {
    animation-delay: 0.1s;
  }
  .history-card:nth-child(2) {
    animation-delay: 0.15s;
  }
  .history-card:nth-child(3) {
    animation-delay: 0.2s;
  }
  .history-card:nth-child(4) {
    animation-delay: 0.25s;
  }
  .history-card:nth-child(n + 5) {
    animation-delay: 0.3s;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #lightbox {
    backdrop-filter: blur(10px);
  }

  /* Custom scrollbar for story section */
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(var(--primary), 0.6);
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(var(--primary), 0.8);
  }

  /* Ensure text in cards is limited to 3 lines */
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
